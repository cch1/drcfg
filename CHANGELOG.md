# Change Log
All notable changes to this project will be documented in this file. This change log follows the conventions of [keepachangelog.com](http://keepachangelog.com/).  In the spirit of Rich Hickey's "Spec-ulation" keynote address at the 2016 Clojure/conj, no backwards-incompatible changes will be made to any public var after version 7.0.0.  Prior to this version, BC was generally preserved only within major releases.

Note that versioning is managed using [lein-v](https://clojars.org/com.roomkey/lein-v).

## [Unreleased](https://github.com/cch1/drcfg/compare/v7.1.0...HEAD) ##

### Changed ###
- Adopt the persistent recursive watches available since Zookeeper 3.6.0.  This is not an optional requirement so please ensure your cluster is running Zookeeper version 3.6.0 or later.
- Changed the namespaces providing the functionality.  Instead of living under the `roomkey` namespace, all functionality now lives under the `zk` namespace.  Otherwise new namespaces are obviously named to correspond to the old namespaces with only the removal of the initial `z` from znode and zclient.  Corresponding test namespaces have been renamed as well.
- Changed namespaces: the top-level `zk.drcfg` namespace is 100% backwards compatible with its corresponding legacy `roomkey.drcfg` namespace.  Lower-level namespaces such as `zk.zref` (previously `roomkey.zref`) and `zk.node` (previously `roomkey.znode`) are highly backwards-compatible.  However, the `zk.client` namespace (previously the `roomkey.zclient` namespace`) has changed more substantially.


## [7.1.0](https://github.com/cch1/drcfg/compare/v7.0.1...v7.1.0) ##

### Fixed ###
- Fixed bug in processing of `:validator` option.

## [7.0.1](https://github.com/cch1/drcfg/compare/v7.0.0...v7.0.1) ##

### Changed ###
- Converted to an open source project with proper license, documentation and deployment target.

## [7.0.0](https://github.com/cch1/drcfg/compare/v6.6.1...v7.0.0) ##

### Added ###
- Switch to more conventional format for CHANGELOG with subheadings and links to relevant git log entries.
- The `roomkey.drcfg/db-initialize!` function creates the root znode (and any subordinate "scoped" znodes) explicitly.

### Changed ###
- Overhaul ZNode watch functionality.
- ZNodes must be created by their parents -or "externally".
- A clearer distinction of boot-versus-steady-state has been introduced via a go block returning a go block -it impacts when children are created
versus locally de-registered.  Within a given ZNode's watch, it ensures that children or data are not checked until the node actually exists.
- Reserve updating of a ZNode's state (stat, data, children) to event callback channel operations
instead of doing it synchronously within remote operations.

### Deprecated ###

### Removed ###
- ZNodes are no longer created automatically as part of the "watch" invocation: they are created by their parents.
- The root ZNode has no parent and must be created externally.  The `drcfg/db-initialize!` function will do this.
- Eliminate the reported distinction of "abrupt" versus "normal" shutdown.  ZNodes now simply report the number of children they
have watched via their watch's returned channel-in-a-channel.

### Fixed ###
- Duplicate events are no longer generated by ZNodes watches due to consolidation of all watchers of a ZNode into a single object.
- Removed blocking operations from within go blocks via judicious use of `async/thread`, nested go blocks
and parkable operations.  See [clojure.core.async.go-checking](https://insideclojure.org/2019/12/06/journal/) for details on how
these kinds of non-deterministic bugs can be identified.

### Security ###

## Version 6.6.1
* Convey Clojure `*data-readers*` to `edn/read-string` when deserializing.

## Version 6.6.0
* Switch to EDN-encoding on the server.  Note that a migration is required to cleanly preserve existing persisted data.
* Add `roomkey.znode/walk` to facilitate migration of data, amongst other uses.

## Version 6.5.0
* Expand events emitted by ZNodes

## Version 6.4.4
* Handle :Closed keeper-state in ZClient

## Version 6.4.3
* Prevent deadlock during shutdown of a ZNode tree. The Closable
  returned by ZNode/watch now returns a channel upon invokation,
  instead of blocking.

## Version 6.4.2
* Fix `roomkey.drcfg/def>` to properly support using a map as the default value

## Version 6.4.1
* Bump dependencies, namely:
  org.clojure/clojure 1.10.0 -> 1.10.1
  org.clojure/core.async 0.4.490 -> 0.4.500
  org.clojure/tools.logging 0.4.1 -> 0.5.0
  org.apache.zookeeper/zookeeper 3.5.4-beta -> 3.5.5

## Version 6.4.0
* Return stat data structures from `znode/create!` and `znode/compare-version-and-set!`.  This requires newish versions of Zookeeper.

## Version 6.3.1
* Add missing dependency on `org.clojure/tools.macro`

## Version 6.3.0
* Fix bad behavior that allowed sync'd ZNodes to be re-initialized with default values

## Version 6.2.1
* Add type hints and decrease reflection.
* Tweak logging.

## Version 6.2.0
* Add clojure.lang.IFn support on ZClient.
* Overhaul ZNode startup and boot process.
* Refactor for performance, simplicity.

## Version 6.1.0
* Overhaul open and close to squash out race conditions
* Tweak logging

## Version 6.0.0
### Big changes to ZRefs and ZClient, but only small changes to API of drcfg
* Deprecate `zref/zref` in favor of `zref/create`
* Promote Stat metadata to `java.time.Instant` from millis.
* Introduce light-weight ZNode for proxying hierarchy of ZooKeeper nodes, and refactor ZRefs to leverage ZNode
* Bind zrefs to a znode (and indirectly to a drcfg client -not just a ZooKeeper client).
* Use znode attribute as sole coordination point between clients and zrefs.
* Validate inbound updates from server.
* zclient implements IDeref and dereferencing zclient yields current ZooKeeper client.
* zclient implements Mult and can be tapped for client events.
* Complete overhaul of integration testing for more deterministic results.
* Refactor ZRef cache for efficiency.
* Add ZNode metadata to return of vDeref method.
* Add `drcfg/def>` with "standard" Clojure metadata support and breaking down period-separted Clojure namespaces into ZooKeeper paths.
